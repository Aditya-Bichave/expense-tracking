name: Flutter CI (Strict)

on:
  pull_request:
    paths:
      - "lib/**"
      - "test/**"
      - "pubspec.yaml"
      - "analysis_options.yaml"
      - ".github/workflows/**"
      - "web/**"
      - "ci/**"
      - "ios/**"
      - "android/**"
      - "Dockerfile"
      - "nginx.conf"
      - "README_CI.md"
  push:
    branches: [ main ]
    paths:
      - "lib/**"
      - "test/**"
      - "pubspec.yaml"
      - "analysis_options.yaml"
      - ".github/workflows/**"
      - "web/**"
      - "ci/**"
      - "ios/**"
      - "android/**"
      - "Dockerfile"
      - "nginx.conf"
      - "README_CI.md"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write # Required for posting comments

jobs:
  static-checks:
    name: üõ°Ô∏è Static Checks & Policy
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Format Check (Fail Fast)
        run: dart format . --output=none --set-exit-if-changed

      - name: Cache Pub Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze
        run: flutter analyze

      - name: Policy Check (No Print/TODO)
        if: github.event_name == 'pull_request'
        run: |
          chmod +x ci/policy/check_new_code.sh
          ./ci/policy/check_new_code.sh ${{ github.base_ref }}

      - name: Codegen Consistency Check
        if: github.event_name == 'pull_request'
        run: |
          chmod +x ci/policy/check_codegen.sh
          ./ci/policy/check_codegen.sh ${{ github.base_ref }}

      - name: Dependency Review
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high

  unit-tests:
    name: üß™ Unit Tests & Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Cache Pub Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Run Tests (including Goldens)
        run: flutter test --coverage --test-randomize-ordering-seed=random --concurrency 4

      - name: Install diff-cover
        if: github.event_name == 'pull_request'
        run: pip install diff-cover

      - name: Check Diff Coverage (80%)
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1 || true
          diff-cover coverage/lcov.info --compare-branch=origin/${{ github.base_ref }} --fail-under=80

      - name: Enforce Total Coverage (35%)
        run: |
          awk -F: '/^LF:/{lf+=$2} /^LH:/{lh+=$2} END{ pct=(lf?100*lh/lf:0); printf("Coverage: %.2f%%\n", pct); if (pct<35) { print "Coverage below 35%!"; exit 1 } }' coverage/lcov.info

      - name: Upload Coverage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/lcov.info
          retention-days: 1

  web-build:
    name: üåê Web Build & Bundle Size
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Cache Pub Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Build Web
        run: flutter build web --release

      - name: Check Bundle Size
        run: node ci/scripts/bundle_size.js

      - name: Upload Bundle Report
        uses: actions/upload-artifact@v4
        with:
          name: bundle-size
          path: ci/scripts/bundle-size-report.json
          retention-days: 1

      - name: Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web
          retention-days: 1

  web-smoke:
    name: üí® Web Smoke Tests
    runs-on: ubuntu-latest
    needs: web-build
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Download Web Build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: build/web

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ci/smoke/package.json

      - name: Install Playwright Deps
        working-directory: ci/smoke
        run: |
          npm ci
          npx playwright install chromium --with-deps

      - name: Run Smoke Tests
        working-directory: ci/smoke
        run: npm run smoke

      - name: Upload Smoke Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test
          path: ci/smoke/smoke-report.json
          retention-days: 1

  pr-report:
    name: üìù PR Report
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    needs: [static-checks, unit-tests, web-build, web-smoke]
    steps:
      - uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate Comment Body
        id: generate_body
        env:
          ARTIFACTS_DIR: artifacts
        run: |
          node ci/scripts/generate_pr_comment.js > pr_comment.md

      - name: Post/Update Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('pr_comment.md')) {
              const body = fs.readFileSync('pr_comment.md', 'utf8');

              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(c => c.body.includes('<!-- ci-summary-bot -->'));

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: body
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: body
                });
              }
            }
